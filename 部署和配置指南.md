# ICE图片查看器 - 部署和配置指南

## 概述

本指南详细说明了ICE图片查看器产品管理系统的部署、配置和运维要求，适用于开发、测试和生产环境。

## 系统要求

### 硬件要求

#### 最低配置
- **CPU**: 2核心，2.0GHz
- **内存**: 4GB RAM
- **存储**: 20GB 可用空间
- **网络**: 1Mbps 带宽

#### 推荐配置
- **CPU**: 4核心，2.5GHz+
- **内存**: 8GB+ RAM
- **存储**: 100GB+ SSD
- **网络**: 10Mbps+ 带宽

#### 生产环境配置
- **CPU**: 8核心，3.0GHz+
- **内存**: 16GB+ RAM
- **存储**: 500GB+ NVMe SSD
- **网络**: 100Mbps+ 带宽
- **负载均衡**: 支持多实例部署

### 软件要求

#### 基础环境
- **操作系统**: 
  - Linux: Ubuntu 18.04+, CentOS 7+, RHEL 7+
  - macOS: 10.14+
  - Windows: Windows Server 2016+
- **Node.js**: 版本 14.0.0 或更高版本
- **npm**: 版本 6.0.0 或更高版本

#### 生产环境依赖
- **PM2**: 进程管理器（推荐）
- **Nginx**: 反向代理和静态文件服务
- **SSL证书**: HTTPS支持
- **监控工具**: 系统监控和日志收集

## 开发环境部署

### 1. 环境准备

#### 安装Node.js
```bash
# 使用NodeSource仓库安装Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### 克隆项目
```bash
# 克隆项目到本地
git clone <repository-url>
cd product-management-system

# 检查项目结构
ls -la
```

### 2. 依赖安装

```bash
# 安装所有依赖
npm install

# 验证依赖安装
npm list --depth=0
```

### 3. 目录权限设置

```bash
# 创建必要的目录并设置权限
mkdir -p Product uploads
chmod 755 Product uploads

# 设置所有者（Linux/macOS）
sudo chown -R $USER:$USER Product uploads
```

### 4. 开发环境启动

```bash
# 方式1：同时启动前后端（推荐）
npm run start

# 方式2：分别启动
npm run dev    # 前端开发服务器
npm run server # 后端服务器

# 访问应用
# 前端: http://localhost:5173
# 后端: http://localhost:3000
```

## 生产环境部署

### 1. 服务器准备

#### Ubuntu/Debian系统
```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装必要的软件
sudo apt install -y curl wget git build-essential

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装PM2
sudo npm install -g pm2
```

#### CentOS/RHEL系统
```bash
# 更新系统包
sudo yum update -y

# 安装开发工具
sudo yum groupinstall -y "Development Tools"
sudo yum install -y curl wget git

# 安装Node.js
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 安装PM2
sudo npm install -g pm2
```

### 2. 项目部署

#### 部署脚本
```bash
#!/bin/bash
# deploy.sh - 生产环境部署脚本

set -e

# 设置变量
PROJECT_DIR="/var/www/product-management-system"
BACKUP_DIR="/var/backups/product-management"
NODE_VERSION="18"

# 创建项目目录
sudo mkdir -p $PROJECT_DIR
sudo chown $USER:$USER $PROJECT_DIR

# 备份现有部署
if [ -d "$PROJECT_DIR/.git" ]; then
    echo "创建备份..."
    sudo mkdir -p $BACKUP_DIR
    BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)"
    sudo cp -r $PROJECT_DIR $BACKUP_DIR/$BACKUP_NAME
fi

# 部署新版本
echo "部署新版本..."
cd $PROJECT_DIR

# 拉取最新代码
git pull origin main

# 安装依赖
npm ci --production

# 构建前端
npm run build

# 设置权限
sudo chown -R www-data:www-data $PROJECT_DIR
sudo chmod -R 755 $PROJECT_DIR
sudo chmod -R 777 Product uploads

# 重启应用
pm2 restart all

echo "部署完成！"
```

### 3. PM2进程管理

#### PM2配置文件 (ecosystem.config.js)
```javascript
module.exports = {
  apps: [{
    name: 'product-management',
    script: 'server.js',
    cwd: '/var/www/product-management-system',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    log_file: '/var/log/pm2/product-management.log',
    out_file: '/var/log/pm2/product-management-out.log',
    error_file: '/var/log/pm2/product-management-error.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024'
  }]
};
```

#### PM2管理命令
```bash
# 启动应用
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs product-management

# 重启应用
pm2 restart product-management

# 停止应用
pm2 stop product-management

# 删除应用
pm2 delete product-management

# 监控面板
pm2 monit
```

### 4. Nginx配置

#### Nginx配置文件 (/etc/nginx/sites-available/product-management)
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # 静态文件缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        root /var/www/product-management-system/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # API代理
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 产品文件访问
    location /Product/ {
        root /var/www/product-management-system;
        expires 1M;
        add_header Cache-Control "public";
        access_log off;
    }
    
    # 数据文件访问
    location /data/ {
        root /var/www/product-management-system/public;
        expires 1h;
        add_header Cache-Control "public";
    }
    
    # 单页应用路由
    location / {
        root /var/www/product-management-system/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }
    
    # 安全配置
    client_max_body_size 100M;
    server_tokens off;
    
    # 日志配置
    access_log /var/log/nginx/product-management.access.log;
    error_log /var/log/nginx/product-management.error.log;
}
```

#### 启用站点
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/product-management /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl reload nginx

# 设置开机自启
sudo systemctl enable nginx
```

## 环境配置

### 1. 环境变量

#### 开发环境 (.env.development)
```bash
NODE_ENV=development
PORT=3000
API_BASE_URL=http://localhost:3000
UPLOAD_MAX_SIZE=104857600
ENABLE_CORS=true
LOG_LEVEL=debug
```

#### 生产环境 (.env.production)
```bash
NODE_ENV=production
PORT=3000
API_BASE_URL=https://your-domain.com
UPLOAD_MAX_SIZE=104857600
ENABLE_CORS=false
LOG_LEVEL=info
SESSION_SECRET=your-session-secret-key
```

### 2. 应用配置

#### config/app.config.js
```javascript
module.exports = {
  // 服务器配置
  server: {
    port: process.env.PORT || 3000,
    host: '0.0.0.0',
    timeout: 30000
  },
  
  // 文件上传配置
  upload: {
    maxFileSize: 100 * 1024 * 1024, // 100MB
    allowedTypes: ['image/jpeg', 'image/png', 'image/webp', 'application/zip'],
    uploadPath: './uploads',
    tempPath: './temp'
  },
  
  // 产品配置
  product: {
    basePath: './Product',
    supportedFormats: ['webp', 'png', 'jpg', 'jpeg'],
    frameCount: 32,
    viewCount: 4
  },
  
  // 安全配置
  security: {
    corsOrigins: process.env.NODE_ENV === 'production' 
      ? ['https://your-domain.com'] 
      : ['http://localhost:5173'],
    rateLimit: {
      windowMs: 15 * 60 * 1000, // 15分钟
      max: 1000 // 限制每个IP 15分钟内最多1000个请求
    }
  },
  
  // 日志配置
  logging: {
    level: process.env.LOG_LEVEL || 'info',
    file: './logs/app.log',
    maxFiles: 10,
    maxSize: '20m'
  }
};
```

## 监控和维护

### 1. 日志管理

#### 日志轮转配置 (/etc/logrotate.d/product-management)
```
/var/log/pm2/product-management*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    copytruncate
    postrotate
        pm2 reloadLogs
    endscript
}

/var/log/nginx/product-management.*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    copytruncate
}
```

#### 日志监控脚本
```bash
#!/bin/bash
# log-monitor.sh - 日志监控脚本

LOG_FILE="/var/log/product-management-monitor.log"
ERROR_THRESHOLD=10

# 统计错误日志
ERROR_COUNT=$(grep -c "ERROR" /var/log/pm2/product-management-error.log | tail -1)

if [ $ERROR_COUNT -gt $ERROR_THRESHOLD ]; then
    echo "$(date): 检测到 $ERROR_COUNT 个错误，超过阈值 $ERROR_THRESHOLD" >> $LOG_FILE
    # 发送告警邮件
    echo "应用错误过多，请检查日志" | mail -s "产品管理系统告警" admin@your-domain.com
fi
```

### 2. 性能监控

#### 系统监控脚本
```bash
#!/bin/bash
# system-monitor.sh - 系统性能监控

# CPU使用率
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')

# 内存使用率
MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')

# 磁盘使用率
DISK_USAGE=$(df -h / | awk 'NR==2{print $5}' | sed 's/%//')

# PM2进程状态
PM2_STATUS=$(pm2 jlist | jq -r '.[0].pm2_env.status')

# 记录监控数据
echo "$(date): CPU=${CPU_USAGE}%, MEM=${MEMORY_USAGE}%, DISK=${DISK_USAGE}%, PM2=${PM2_STATUS}" >> /var/log/system-monitor.log

# 性能告警
if (( $(echo "$CPU_USAGE > 80" | bc -l) )); then
    echo "警告: CPU使用率过高 (${CPU_USAGE}%)" | mail -s "性能告警" admin@your-domain.com
fi

if (( $(echo "$MEMORY_USAGE > 85" | bc -l) )); then
    echo "警告: 内存使用率过高 (${MEMORY_USAGE}%)" | mail -s "性能告警" admin@your-domain.com
fi

if [ $DISK_USAGE -gt 90 ]; then
    echo "警告: 磁盘使用率过高 (${DISK_USAGE}%)" | mail -s "存储告警" admin@your-domain.com
fi
```

### 3. 定时任务

#### 添加到crontab
```bash
# 编辑crontab
crontab -e

# 添加以下任务
# 每5分钟监控一次系统性能
*/5 * * * * /path/to/system-monitor.sh

# 每天凌晨2点备份数据
0 2 * * * /path/to/backup.sh

# 每周清理一次临时文件
0 3 * * 0 /path/to/cleanup.sh

# 每天检查日志错误
0 1 * * * /path/to/log-monitor.sh
```

### 4. 备份策略

#### 数据备份脚本
```bash
#!/bin/bash
# backup.sh - 数据备份脚本

BACKUP_DIR="/var/backups/product-management"
DATE=$(date +%Y%m%d-%H%M%S)
PROJECT_DIR="/var/www/product-management-system"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份产品文件
echo "备份产品文件..."
tar -czf $BACKUP_DIR/Product-$DATE.tar.gz -C $PROJECT_DIR Product

# 备份配置文件
echo "备份配置文件..."
tar -czf $BACKUP_DIR/Config-$DATE.tar.gz \
    $PROJECT_DIR/package.json \
    $PROJECT_DIR/vite.config.js \
    $PROJECT_DIR/tailwind.config.js \
    $PROJECT_DIR/.env.production

# 备份上传文件
echo "备份上传文件..."
tar -czf $BACKUP_DIR/Uploads-$DATE.tar.gz -C $PROJECT_DIR uploads

# 清理7天前的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: $DATE"
```

## 故障排除

### 1. 常见问题

#### 端口占用
```bash
# 查看端口占用
sudo netstat -tulpn | grep :3000

# 终止占用进程
sudo kill -9 <PID>
```

#### 权限问题
```bash
# 修复目录权限
sudo chown -R www-data:www-data /var/www/product-management-system
sudo chmod -R 755 /var/www/product-management-system
sudo chmod -R 777 /var/www/product-management-system/Product
sudo chmod -R 777 /var/www/product-management-system/uploads
```

#### 依赖问题
```bash
# 清理依赖重新安装
rm -rf node_modules package-lock.json
npm install

# 清理PM2缓存
pm2 flush
pm2 restart all
```

### 2. 性能优化

#### Node.js优化
```bash
# 设置环境变量
export NODE_OPTIONS="--max-old-space-size=1024"
export UV_THREADPOOL_SIZE=16
```

#### 数据库优化（如果添加数据库）
```sql
-- 添加索引
CREATE INDEX idx_products_name ON products(name);
CREATE INDEX idx_products_created_at ON products(created_at);

-- 优化查询
ANALYZE products;
```

### 3. 安全加固

#### 防火墙配置
```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

#### SSL证书配置
```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 自动续期
sudo crontab -e
# 添加：0 12 * * * /usr/bin/certbot renew --quiet
```

## 扩展部署

### 1. Docker部署

#### Dockerfile
```dockerfile
FROM node:18-alpine

WORKDIR /app

# 复制package文件
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制应用代码
COPY . .

# 构建前端
RUN npm run build

# 创建非root用户
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# 设置权限
RUN chown -R nextjs:nodejs /app
USER nextjs

# 暴露端口
EXPOSE 3000

# 启动应用
CMD ["npm", "run", "prod"]
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    volumes:
      - ./Product:/app/Product
      - ./uploads:/app/uploads
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped
```

### 2. 集群部署

#### 负载均衡配置
```nginx
upstream product_management {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

server {
    listen 80;
    location / {
        proxy_pass http://product_management;
    }
}
```

#### 多实例PM2配置
```javascript
module.exports = {
  apps: [{
    name: 'product-management',
    script: 'server.js',
    instances: 4,
    exec_mode: 'cluster',
    env: {
      PORT: 3000
    },
    env_production: {
      PORT: 3000
    }
  }]
};
```

## 升级和维护

### 1. 版本升级

#### 升级流程
```bash
# 1. 备份当前版本
./backup.sh

# 2. 拉取新版本
git pull origin main

# 3. 更新依赖
npm ci --production

# 4. 运行数据库迁移（如果有）
npm run migrate

# 5. 重新构建
npm run build

# 6. 重启服务
pm2 restart product-management

# 7. 验证功能
curl -f http://localhost:3000/api/health
```

### 2. 监控检查清单

#### 日常检查
- [ ] 应用状态正常
- [ ] 响应时间正常
- [ ] 错误日志无异常
- [ ] 磁盘空间充足
- [ ] 内存使用正常
- [ ] CPU使用率正常

#### 定期维护
- [ ] 更新系统包
- [ ] 更新Node.js版本
- [ ] 清理临时文件
- [ ] 检查SSL证书
- [ ] 备份验证
- [ ] 性能测试

---

本部署和配置指南为ICE图片查看器的生产环境部署提供了完整的指导，确保系统能够稳定、高效地运行。在实际部署过程中，请根据具体环境调整配置参数。